OpenLayers.Layer.WMTS=OpenLayers.Class(OpenLayers.Layer.Grid,{isBaseLayer:!0,version:"1.0.0",requestEncoding:"KVP",url:null,layer:null,matrixSet:null,style:null,format:"image/jpeg",tileOrigin:null,tileFullExtent:null,formatSuffix:null,matrixIds:null,dimensions:null,params:null,zoomOffset:0,serverResolutions:null,formatSuffixMap:{"image/png":"png","image/png8":"png","image/png24":"png","image/png32":"png",png:"png","image/jpeg":"jpg","image/jpg":"jpg",jpeg:"jpg",jpg:"jpg"},matrix:null,initialize:function(t){var i={url:!0,layer:!0,style:!0,matrixSet:!0};for(var e in i)if(!(e in t))throw new Error("Missing property '"+e+"' in layer configuration.");t.params=OpenLayers.Util.upperCaseObject(t.params);var r=[t.name,t.url,t.params,t];if(OpenLayers.Layer.Grid.prototype.initialize.apply(this,r),this.formatSuffix||(this.formatSuffix=this.formatSuffixMap[this.format]||this.format.split("/").pop()),this.matrixIds){var s=this.matrixIds.length;if(s&&"string"==typeof this.matrixIds[0]){var a=this.matrixIds;this.matrixIds=new Array(s);for(var n=0;s>n;++n)this.matrixIds[n]={identifier:a[n]}}}},setMap:function(){OpenLayers.Layer.Grid.prototype.setMap.apply(this,arguments)},updateMatrixProperties:function(){this.matrix=this.getMatrix(),this.matrix&&(this.matrix.topLeftCorner&&(this.tileOrigin=this.matrix.topLeftCorner),this.matrix.tileWidth&&this.matrix.tileHeight&&(this.tileSize=new OpenLayers.Size(this.matrix.tileWidth,this.matrix.tileHeight)),this.tileOrigin||(this.tileOrigin=new OpenLayers.LonLat(this.maxExtent.left,this.maxExtent.top)),this.tileFullExtent||(this.tileFullExtent=this.maxExtent))},moveTo:function(t,i){return(i||!this.matrix)&&this.updateMatrixProperties(),OpenLayers.Layer.Grid.prototype.moveTo.apply(this,arguments)},clone:function(t){return null==t&&(t=new OpenLayers.Layer.WMTS(this.options)),t=OpenLayers.Layer.Grid.prototype.clone.apply(this,[t])},getIdentifier:function(){return this.getServerZoom()},getMatrix:function(){var t;if(this.matrixIds&&0!==this.matrixIds.length)if("scaleDenominator"in this.matrixIds[0])for(var i,e=OpenLayers.METERS_PER_INCH*OpenLayers.INCHES_PER_UNIT[this.units]*this.getServerResolution()/28e-5,r=Number.POSITIVE_INFINITY,s=0,a=this.matrixIds.length;a>s;++s)i=Math.abs(1-this.matrixIds[s].scaleDenominator/e),r>i&&(r=i,t=this.matrixIds[s]);else t=this.matrixIds[this.getIdentifier()];else t={identifier:this.getIdentifier()};return t},getTileInfo:function(t){var i=this.getServerResolution(),e=(t.lon-this.tileOrigin.lon)/(i*this.tileSize.w),r=(this.tileOrigin.lat-t.lat)/(i*this.tileSize.h),s=Math.floor(e),a=Math.floor(r);return{col:s,row:a,i:Math.floor((e-s)*this.tileSize.w),j:Math.floor((r-a)*this.tileSize.h)}},getURL:function(t){t=this.adjustBounds(t);var i="";if(!this.tileFullExtent||this.tileFullExtent.intersectsBounds(t)){var e,r=t.getCenterLonLat(),s=this.getTileInfo(r),a=(this.matrix.identifier,this.dimensions);if(i=OpenLayers.Util.isArray(this.url)?this.selectUrl([this.version,this.style,this.matrixSet,this.matrix.identifier,s.row,s.col].join(","),this.url):this.url,"REST"===this.requestEncoding.toUpperCase())if(e=this.params,-1!==i.indexOf("{")){var n=i.replace(/\{/g,"${"),l={style:this.style,Style:this.style,TileMatrixSet:this.matrixSet,TileMatrix:this.matrix.identifier,TileRow:s.row,TileCol:s.col};if(a){var o,h;for(h=a.length-1;h>=0;--h)o=a[h],l[o]=e[o.toUpperCase()]}i=OpenLayers.String.format(n,l)}else{var p=this.version+"/"+this.layer+"/"+this.style+"/";if(a)for(var h=0;h<a.length;h++)e[a[h]]&&(p=p+e[a[h]]+"/");p=p+this.matrixSet+"/"+this.matrix.identifier+"/"+s.row+"/"+s.col+"."+this.formatSuffix,i.match(/\/$/)||(i+="/"),i+=p}else"KVP"===this.requestEncoding.toUpperCase()&&(e={SERVICE:"WMTS",REQUEST:"GetTile",VERSION:this.version,LAYER:this.layer,STYLE:this.style,TILEMATRIXSET:this.matrixSet,TILEMATRIX:this.matrix.identifier,TILEROW:s.row,TILECOL:s.col,FORMAT:this.format},i=OpenLayers.Layer.Grid.prototype.getFullRequestString.apply(this,[e]))}return i},mergeNewParams:function(t){return"KVP"===this.requestEncoding.toUpperCase()?OpenLayers.Layer.Grid.prototype.mergeNewParams.apply(this,[OpenLayers.Util.upperCaseObject(t)]):void 0},CLASS_NAME:"OpenLayers.Layer.WMTS"});