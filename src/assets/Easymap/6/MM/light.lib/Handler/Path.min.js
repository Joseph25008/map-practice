OpenLayers.Handler.Path=OpenLayers.Class(OpenLayers.Handler.Point,{line:null,maxVertices:null,doubleTouchTolerance:20,freehand:!1,freehandToggle:"shiftKey",timerId:null,redoStack:null,createFeature:function(t){var e=this.layer.getLonLatFromViewPortPx(t),i=new OpenLayers.Geometry.Point(e.lon,e.lat);this.point=new OpenLayers.Feature.Vector(i),this.line=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.LineString([this.point.geometry])),this.callback("create",[this.point.geometry,this.getSketch()]),this.point.geometry.clearBounds(),this.layer.addFeatures([this.line,this.point],{silent:!0})},destroyFeature:function(t){OpenLayers.Handler.Point.prototype.destroyFeature.call(this,t),this.line=null},destroyPersistedFeature:function(){var t=this.layer;t&&t.features.length>2&&this.layer.features[0].destroy()},removePoint:function(){this.point&&this.layer.removeFeatures([this.point])},addPoint:function(t){this.layer.removeFeatures([this.point]);var e=this.layer.getLonLatFromViewPortPx(t);this.point=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(e.lon,e.lat)),this.line.geometry.addComponent(this.point.geometry,this.line.geometry.components.length),this.layer.addFeatures([this.point]),this.callback("point",[this.point.geometry,this.getGeometry()]),this.callback("modify",[this.point.geometry,this.getSketch()]),this.drawFeature(),delete this.redoStack},insertXY:function(t,e){this.line.geometry.addComponent(new OpenLayers.Geometry.Point(t,e),this.getCurrentPointIndex()),this.drawFeature(),delete this.redoStack},insertDeltaXY:function(t,e){var i=this.getCurrentPointIndex()-1,n=this.line.geometry.components[i];!n||isNaN(n.x)||isNaN(n.y)||this.insertXY(n.x+t,n.y+e)},insertDirectionLength:function(t,e){t*=Math.PI/180;var i=e*Math.cos(t),n=e*Math.sin(t);this.insertDeltaXY(i,n)},insertDeflectionLength:function(t,e){var i=this.getCurrentPointIndex()-1;if(i>0){var n=this.line.geometry.components[i],s=this.line.geometry.components[i-1],o=Math.atan2(n.y-s.y,n.x-s.x);this.insertDirectionLength(180*o/Math.PI+t,e)}},getCurrentPointIndex:function(){return this.line.geometry.components.length-1},undo:function(){var t=this.line.geometry,e=t.components,i=this.getCurrentPointIndex()-1,n=e[i],s=t.removeComponent(n);if(s){if(this.touch&&i>0){e=t.components;var o=e[i-1],r=this.getCurrentPointIndex(),h=e[r];h.x=o.x,h.y=o.y}this.redoStack||(this.redoStack=[]),this.redoStack.push(n),this.drawFeature()}return s},redo:function(){var t=this.redoStack&&this.redoStack.pop();return t&&(this.line.geometry.addComponent(t,this.getCurrentPointIndex()),this.drawFeature()),!!t},freehandMode:function(t){return this.freehandToggle&&t[this.freehandToggle]?!this.freehand:this.freehand},modifyFeature:function(t,e){this.line||this.createFeature(t);var i=this.layer.getLonLatFromViewPortPx(t);this.point.geometry.x=i.lon,this.point.geometry.y=i.lat,this.callback("modify",[this.point.geometry,this.getSketch(),e]),this.point.geometry.clearBounds(),this.drawFeature()},drawFeature:function(){this.layer.drawFeature(this.line,this.style),this.layer.drawFeature(this.point,this.style)},getSketch:function(){return this.line},getGeometry:function(){var t=this.line&&this.line.geometry;return t&&this.multi&&(t=new OpenLayers.Geometry.MultiLineString([t])),t},touchstart:function(t){return this.timerId&&this.passesTolerance(this.lastTouchPx,t.xy,this.doubleTouchTolerance)?(this.finishGeometry(),window.clearTimeout(this.timerId),this.timerId=null,!1):(this.timerId&&(window.clearTimeout(this.timerId),this.timerId=null),this.timerId=window.setTimeout(OpenLayers.Function.bind(function(){this.timerId=null},this),300),OpenLayers.Handler.Point.prototype.touchstart.call(this,t))},down:function(t){var e=this.stopDown;return this.freehandMode(t)&&(e=!0,this.touch&&(this.modifyFeature(t.xy,!!this.lastUp),OpenLayers.Event.stop(t))),this.touch||this.lastDown&&this.passesTolerance(this.lastDown,t.xy,this.pixelTolerance)||this.modifyFeature(t.xy,!!this.lastUp),this.mouseDown=!0,this.lastDown=t.xy,this.stoppedDown=e,!e},move:function(t){return this.stoppedDown&&this.freehandMode(t)?(this.persist&&this.destroyPersistedFeature(),this.maxVertices&&this.line&&this.line.geometry.components.length===this.maxVertices?(this.removePoint(),this.finalize()):this.addPoint(t.xy),!1):(this.touch||this.mouseDown&&!this.stoppedDown||this.modifyFeature(t.xy,!!this.lastUp),!0)},up:function(t){return!this.mouseDown||this.lastUp&&this.lastUp.equals(t.xy)||(this.stoppedDown&&this.freehandMode(t)?(this.persist&&this.destroyPersistedFeature(),this.removePoint(),this.finalize()):this.passesTolerance(this.lastDown,t.xy,this.pixelTolerance)&&(this.touch&&this.modifyFeature(t.xy),null==this.lastUp&&this.persist&&this.destroyPersistedFeature(),this.addPoint(t.xy),this.lastUp=t.xy,this.line.geometry.components.length===this.maxVertices+1&&this.finishGeometry())),this.stoppedDown=this.stopDown,this.mouseDown=!1,!this.stopUp},finishGeometry:function(){var t=this.line.geometry.components.length-1;this.line.geometry.removeComponent(this.line.geometry.components[t]),this.removePoint(),this.finalize()},dblclick:function(t){return this.freehandMode(t)||this.finishGeometry(),!1},CLASS_NAME:"OpenLayers.Handler.Path"});